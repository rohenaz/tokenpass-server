{"version":3,"file":"index.umd.js","sources":["../key.js","../crypt.js","../seed.js","../state.js","../wallet/bitcore-message.js","../wallet/index.js","../index.js"],"sourcesContent":["class Key {\n  constructor(config) {\n    const dbpath = config.db;\n    this.db = new config.Datastore({\n      filename: dbpath + \"/keys.db\",\n      autoload: true,\n    });\n    this.wallet = config.wallet;\n    this.config = config;\n  }\n  setSeed(s) {\n    this.seed = s;\n  }\n  getSeed() {\n    return this.seed;\n  }\n  sign(o) {\n    return this.wallet.sign(o.message, o.key, o.encoding);\n  }\n  encrypt(o) {\n    return this.wallet.encrypt(o.message, o.key);\n  }\n  async findOrCreate(o) {\n    let key = await this.findOne(o);\n    // create a key if it doesn't exist\n    if (!key) {\n      let count = await this.count({});\n      if (this.seed) {\n        key = await this.wallet.create(this.seed, count, o);\n        key = await this.insert(key);\n      } else {\n        console.log(\"Please go to http://localhost:21000 and create a wallet\");\n        return null;\n      }\n    }\n    return key;\n  }\n  findOne(o) {\n    return new Promise((resolve, reject) => {\n      this.db.findOne(o, (err, key) => {\n        if (key) {\n          resolve(this.transform(key));\n        } else {\n          resolve(null);\n        }\n      });\n    });\n  }\n  find(o) {\n    return new Promise((resolve, reject) => {\n      this.db.find(o, (err, keys) => {\n        resolve(\n          keys.map((k) => {\n            return this.transform(k);\n          })\n        );\n      });\n    });\n  }\n  count(o) {\n    return new Promise((resolve, reject) => {\n      this.db.count(o, (err, count) => {\n        resolve(count);\n      });\n    });\n  }\n  insert(key) {\n    return new Promise((resolve, reject) => {\n      this.db.insert(key, (err, doc) => {\n        resolve(this.transform(key));\n      });\n    });\n  }\n  transform(key) {\n    let derived = this.wallet.derive(this.seed, key.path);\n    key.priv = derived.privateKey.toString();\n    key.pub = derived.publicKey.toString();\n    key.address = derived.publicKey.toAddress().toString();\n    return key;\n  }\n  all() {\n    return new Promise((resolve, reject) => {\n      this.db.find({}, (err, keys) => {\n        resolve(\n          keys.map((k) => {\n            return this.transform(k);\n          })\n        );\n      });\n    });\n  }\n}\nexport default Key;\n","import crypto from \"crypto\";\n\nconst algorithm = \"aes-256-cbc\";\n\nexport function encrypt(text, keystr, keyBuffer) {\n  const iv = crypto.randomBytes(16);\n  if (!keyBuffer)\n    keyBuffer = crypto.createHash(\"sha256\").update(keystr).digest();\n  let cipher = crypto.createCipheriv(\"aes-256-cbc\", keyBuffer, iv);\n  let encrypted = cipher.update(text);\n  encrypted = Buffer.concat([encrypted, cipher.final()]);\n  return { iv: iv.toString(\"hex\"), encryptedData: encrypted.toString(\"hex\") };\n}\n\nexport function decrypt(text, keystr, keyBuffer) {\n  const iv = Buffer.from(text.iv, \"hex\");\n  if (!keyBuffer)\n    keyBuffer = crypto.createHash(\"sha256\").update(keystr).digest();\n  let encryptedText = Buffer.from(text.encryptedData, \"hex\");\n  let decipher = crypto.createDecipheriv(\"aes-256-cbc\", keyBuffer, iv);\n  let decrypted = decipher.update(encryptedText);\n  decrypted = Buffer.concat([decrypted, decipher.final()]);\n  return decrypted.toString();\n}\n","import { decrypt, encrypt } from \"./crypt.js\";\n\nclass Seed {\n  constructor(config) {\n    const dbpath = config.db;\n    this.db = new config.Datastore({\n      filename: dbpath + \"/seed.db\",\n      autoload: true,\n    });\n    this.wallet = config.wallet;\n  }\n  get(password) {\n    return new Promise((resolve, reject) => {\n      this.db.findOne({}, (err, r) => {\n        if (r) {\n          try {\n            let decrypted = decrypt(r.hex, password);\n            let s = this.wallet.seed(decrypted);\n            resolve(s);\n          } catch (e) {\n            resolve(null);\n          }\n        } else {\n          resolve(null);\n        }\n      });\n    });\n  }\n  importKey(hex, password) {\n    return new Promise((resolve, reject) => {\n      try {\n        let s = this.wallet.seed(hex);\n        this.db.insert(\n          {\n            hex: encrypt(s.hex, password),\n          },\n          (err, res) => {\n            resolve(s);\n          }\n        );\n      } catch (e) {\n        reject(e);\n      }\n    });\n  }\n  async exportKey(password) {\n    let s = await this.get(password);\n    return s.hex;\n  }\n  count() {\n    return new Promise((resolve, reject) => {\n      this.db.count({}, (err, count) => {\n        resolve(count);\n      });\n    });\n  }\n  create(password) {\n    return new Promise((resolve, reject) => {\n      let s = this.wallet.seed();\n      this.db.insert(\n        {\n          hex: encrypt(s.hex, password),\n        },\n        (err, res) => {\n          resolve(s);\n        }\n      );\n    });\n  }\n}\nexport default Seed;\n","class State {\n  constructor(config) {\n    const dbpath = config.db;\n    this.db = new config.Datastore({\n      filename: dbpath + \"/state.db\",\n      autoload: true,\n    });\n  }\n  setState(s) {\n    this.state = s;\n  }\n  getState() {\n    return this.state;\n  }\n  async findOrCreate(o) {\n    let state = await this.findOne({ host: o.host });\n    // create a state if it doesn't exist\n    if (!state) {\n      state = await this.insert(o);\n    }\n    return state;\n  }\n  findOne(o) {\n    return new Promise((resolve, reject) => {\n      this.db.findOne(o, (err, state) => {\n        if (state) {\n          delete state._id;\n          resolve(state);\n        } else {\n          resolve(null);\n        }\n      });\n    });\n  }\n  find(o) {\n    return new Promise((resolve, reject) => {\n      this.db.find(o, (err, states) => {\n        resolve(states);\n      });\n    });\n  }\n  delete(o) {\n    return new Promise((resolve, reject) => {\n      this.db.remove(o, (err, states) => {\n        resolve(states);\n      });\n    });\n  }\n  count(o) {\n    return new Promise((resolve, reject) => {\n      this.db.count(o, (err, count) => {\n        resolve(count);\n      });\n    });\n  }\n  insert(state) {\n    return new Promise((resolve, reject) => {\n      this.db.insert(state, (err, doc) => {\n        this.setState(state);\n        resolve(state);\n      });\n    });\n  }\n  update(state) {\n    return new Promise((resolve, reject) => {\n      this.db.update(\n        { host: state.host },\n        { $set: state },\n        {\n          upsert: true,\n          returnUpdatedDocs: true,\n        },\n        (err, numReplaced, doc) => {\n          console.log(\"UPDATED\", { err, accessToken: doc.accessToken });\n          this.setState(doc);\n          resolve(doc);\n        }\n      );\n    });\n  }\n  all() {\n    return new Promise((resolve, reject) => {\n      this.db.find({}, (err, states) => {\n        resolve(states);\n      });\n    });\n  }\n}\nexport default State;\n","\"use strict\";\n\nimport bitcore from \"bitcore-lib\";\nvar _ = bitcore.deps._;\nvar PrivateKey = bitcore.PrivateKey;\nvar PublicKey = bitcore.PublicKey;\nvar Address = bitcore.Address;\nvar BufferWriter = bitcore.encoding.BufferWriter;\nvar ECDSA = bitcore.crypto.ECDSA;\nvar Signature = bitcore.crypto.Signature;\nvar sha256sha256 = bitcore.crypto.Hash.sha256sha256;\nvar JSUtil = bitcore.util.js;\nvar $ = bitcore.util.preconditions;\n\n/**\n * constructs a new message to sign and verify.\n *\n * @param {String} message\n * @param {String=} encoding - The message encoding (either 'utf8', 'base64', or 'hex')\n * @returns {Message}\n */\nvar Message = function Message(message, encoding = \"utf8\") {\n  if (!(this instanceof Message)) {\n    return new Message(message, encoding);\n  }\n  $.checkArgument(\n    _.isString(message),\n    \"First argument should be a string. You can specify the encoding as the second parameter\"\n  );\n  const validEncodings = [\n    \"ascii\",\n    \"utf8\",\n    \"utf16le\",\n    \"ucs2\",\n    \"base64\",\n    \"latin1\",\n    \"binary\",\n    \"hex\",\n  ];\n\n  $.checkArgument(\n    validEncodings.includes(encoding),\n    \"Second argument should be a valid BufferEncoding: 'utf8', 'hex', or 'base64', etc\"\n  );\n\n  this.message = message;\n  this.encoding = encoding;\n\n  return this;\n};\n\nMessage.MAGIC_BYTES = Buffer.from(\"Bitcoin Signed Message:\\n\");\n\nMessage.prototype.magicHash = function magicHash() {\n  var prefix1 = BufferWriter.varintBufNum(Message.MAGIC_BYTES.length);\n  var messageBuffer = Buffer.from(this.message, this.encoding);\n  var prefix2 = BufferWriter.varintBufNum(messageBuffer.length);\n  var buf = Buffer.concat([\n    prefix1,\n    Message.MAGIC_BYTES,\n    prefix2,\n    messageBuffer,\n  ]);\n  var hash = sha256sha256(buf);\n  return hash;\n};\n\nMessage.prototype._sign = function _sign(privateKey) {\n  $.checkArgument(\n    privateKey instanceof PrivateKey,\n    \"First argument should be an instance of PrivateKey\"\n  );\n  var hash = this.magicHash();\n  var ecdsa = new ECDSA();\n  ecdsa.hashbuf = hash;\n  ecdsa.privkey = privateKey;\n  ecdsa.pubkey = privateKey.toPublicKey();\n  ecdsa.signRandomK();\n  ecdsa.calci();\n  return ecdsa.sig;\n};\n\n/**\n * Will sign a message with a given bitcoin private key.\n *\n * @param {PrivateKey} privateKey - An instance of PrivateKey\n * @returns {String} A base64 encoded compact signature\n */\nMessage.prototype.sign = function sign(privateKey) {\n  let wif = privateKey.toWIF();\n  privateKey = PrivateKey.fromWIF(wif);\n  var signature = this._sign(privateKey);\n  return signature.toCompact().toString(\"base64\");\n};\n\nMessage.prototype._verify = function _verify(publicKey, signature) {\n  $.checkArgument(\n    publicKey instanceof PublicKey,\n    \"First argument should be an instance of PublicKey\"\n  );\n  $.checkArgument(\n    signature instanceof Signature,\n    \"Second argument should be an instance of Signature\"\n  );\n  var hash = this.magicHash();\n  var verified = ECDSA.verify(hash, signature, publicKey);\n  if (!verified) {\n    this.error = \"The signature was invalid\";\n  }\n  return verified;\n};\n\n/**\n * Will return a boolean of the signature is valid for a given bitcoin address.\n * If it isn't the specific reason is accessible via the \"error\" member.\n *\n * @param {Address|String} bitcoinAddress - A bitcoin address\n * @param {String} signatureString - A base64 encoded compact signature\n * @returns {Boolean}\n */\nMessage.prototype.verify = function verify(bitcoinAddress, signatureString) {\n  $.checkArgument(bitcoinAddress);\n  $.checkArgument(signatureString && _.isString(signatureString));\n\n  if (_.isString(bitcoinAddress)) {\n    bitcoinAddress = Address.fromString(bitcoinAddress);\n  }\n  var signature = Signature.fromCompact(Buffer.from(signatureString, \"base64\"));\n\n  // recover the public key\n  var ecdsa = new ECDSA();\n  ecdsa.hashbuf = this.magicHash();\n  ecdsa.sig = signature;\n  var publicKey = ecdsa.toPublicKey();\n\n  var signatureAddress = Address.fromPublicKey(\n    publicKey,\n    bitcoinAddress.network\n  );\n\n  // check that the recovered address and specified address match\n  if (bitcoinAddress.toString() !== signatureAddress.toString()) {\n    this.error = \"The signature did not match the message digest\";\n    return false;\n  }\n\n  return this._verify(publicKey, signature);\n};\n\n/**\n * Instantiate a message from a message string\n *\n * @param {String} str - A string of the message\n * @returns {Message} A new instance of a Message\n */\nMessage.fromString = function (str) {\n  return new Message(str);\n};\n\n/**\n * Instantiate a message from JSON\n *\n * @param {String} json - An JSON string or Object with keys: message\n * @returns {Message} A new instance of a Message\n */\nMessage.fromJSON = function fromJSON(json) {\n  if (JSUtil.isValidJSON(json)) {\n    json = JSON.parse(json);\n  }\n  return new Message(json.message);\n};\n\n/**\n * @returns {Object} A plain object with the message information\n */\nMessage.prototype.toObject = function toObject() {\n  return {\n    message: this.message,\n    encoding: this.encoding,\n  };\n};\n\n/**\n * @returns {String} A JSON representation of the message information\n */\nMessage.prototype.toJSON = function toJSON() {\n  return JSON.stringify(this.toObject());\n};\n\n/**\n * Will return a the string representation of the message\n *\n * @returns {String} Message\n */\nMessage.prototype.toString = function () {\n  return this.message;\n};\n\n/**\n * Will return a string formatted for the console\n *\n * @returns {String} Message\n */\nMessage.prototype.inspect = function () {\n  return \"<Message: \" + this.toString() + \">\";\n};\n\nexport default Message;\n","import bitcore from \"bitcore-lib\";\nimport { encrypt as enc } from \"../crypt.js\";\nimport Message from \"./bitcore-message.js\";\ndelete global._bitcore;\n// console.log(identity.toJSON());\n\nexport const sign = (message, key, encoding) => {\n  const privateKey = bitcore.PrivateKey.fromWIF(key.priv);\n  const msg = Message(message, encoding);\n  return {\n    address: key.address,\n    message: message,\n    sig: msg.sign(privateKey),\n    ts: Date.now(),\n  };\n};\n\nexport const encrypt = (message, key) => {\n  const privateKey = bitcore.PrivateKey.fromWIF(key.priv).toBuffer();\n  const data = enc(message, null, privateKey);\n  return {\n    address: key.address,\n    data,\n    ts: Date.now(),\n  };\n};\n\nexport const create = async (seed, account, o) => {\n  /********************************************************************\n   * The derivation path follows the\n   * BIP44 standard with a twist:\n   *\n   * - A new account is created per web host\n   * - It uses a new branch of \"2\" instead of (0 or 1)\n   *\n   * This way there is no overlap with existing BIP44 walletse but\n   * the wallet scheme can seamlessly integrate with them.\n   *\n   ********************************************************************/\n  const StarfishBranch = 2;\n  const path = `m/44'/0'/${account}'/${StarfishBranch}/0`;\n  const derived = seed.key.deriveChild(path);\n  const address = derived.privateKey.toAddress().toString();\n  const keys = {\n    path,\n    pub: derived.publicKey.toString(),\n    address,\n    host: o.host,\n  };\n\n  return keys;\n};\n\nexport const seed = (hex) => {\n  let buf = hex\n    ? Buffer.from(hex, \"hex\")\n    : bitcore.crypto.Random.getRandomBuffer(64);\n  try {\n    let key = bitcore.HDPrivateKey.fromSeed(buf);\n    return {\n      hex: buf.toString(\"hex\"),\n      key: key,\n    };\n  } catch (e) {\n    console.log(\"error\", e);\n    throw e;\n  }\n};\n\nexport const derive = (seed, path) => {\n  return seed.key.deriveChild(path);\n};\n\nexport const verify = (message, address, sig, encoding) => {\n  return Message(message, encoding).verify(address, sig);\n};\n","import bodyParser from \"body-parser\";\nimport timeout from \"connect-timeout\";\nimport cors from \"cors\";\nimport { randomUUID } from \"crypto\";\nimport express from \"express\";\nimport fs from \"fs\";\nimport Datastore from \"nedb\";\nimport path, { dirname } from \"path\";\nimport { fileURLToPath } from \"url\";\nimport Key from \"./key.js\";\nimport Seed from \"./seed.js\";\nimport State from \"./state.js\";\nimport * as Wallet from \"./wallet/index.js\";\n\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n\nconst app = express();\nconst TIMEOUT = 20;\nconst defaultPort = 21000;\nconst defaultExpireTime = \"once\";\n\nconst allowedOrigins = [\n  `http://${process.env.TOKENPASS_HOST || \"localhost\"}:${\n    process.env.TOKENPASS_PORT || \"21000\"\n  }`,\n];\nconst whitelist = process.env.TOKENPASS_ORIGIN_WHITELIST;\nif (whitelist) {\n  allowedOrigins.push(...whitelist.split(\",\"));\n}\n\nconst hostFromOrigin = (headers) => {\n  return headers.origin ? new URL(headers.origin).host : null; // \"localhost\";\n};\n\nconst expireSelectionToTime = (expireSelection) => {\n  switch (expireSelection) {\n    case \"forever\":\n      return 0;\n    case \"once\":\n      return 10000;\n    case \"1h\":\n      return 3600000;\n    case \"1d\":\n      return 86400000;\n    case \"1w\":\n      return 604800000;\n    case \"1m\":\n      return 2592000000;\n    default:\n      return defaultExpireTime;\n  }\n};\n\nconst init = (config) => {\n  const dbpath = config.db;\n  if (!fs.existsSync(dbpath)) fs.mkdirSync(dbpath, { recursive: true });\n  const seed = new Seed({ db: dbpath, wallet: Wallet, Datastore: Datastore });\n  const K = new Key({ db: dbpath, wallet: Wallet, Datastore: Datastore });\n  const S = new State({ db: dbpath, Datastore: Datastore });\n  app.set(\"views\", path.join(__dirname, \"views\"));\n  app.set(\"view engine\", \"ejs\");\n  app.use(timeout(\"\" + TIMEOUT + \"s\"));\n  app.use(bodyParser.json({ limit: \"50mb\" }));\n  app.use(bodyParser.raw({ type: \"application/octet-stream\", limit: \"50mb\" }));\n  app.use(bodyParser.urlencoded({ limit: \"50mb\", extended: true }));\n  app.use(express.static(path.join(__dirname, \"public\")));\n  app.options(\"*\", cors());\n  app.use(express.urlencoded({ extended: false }));\n\n  // Sign a message\n  app.post(\"/sign\", cors(), async (req, res) => {\n    // when a tokenpass wallet connects the referrer is empty\n    console.log(\"SIGN ATTEMPTED FROM\", req.headers.origin, {\n      message: req.body.message,\n      authToken: req.headers.authorization,\n    });\n    let message = req.body.message;\n    let encoding = req.body.encoding || \"utf8\";\n\n    if (K.getSeed()) {\n      // Check for an access token\n      const accessToken = req.headers.authorization;\n      if ((accessToken === undefined) | (accessToken === null)) {\n        res.status(401).json({\n          error: \"Please provide an access token in the Authorization header.\",\n          code: 2,\n          success: false,\n          errorURL: `http://${process.env.TOKENPASS_HOST || \"localhost\"}:${\n            process.env.TOKENPASS_PORT || \"21000\"\n          }/auth`,\n        });\n        return;\n      }\n\n      // Check that the access token is valid\n      const state = await S.findOne({ accessToken });\n\n      if (!state?.accessToken || state.accessToken !== accessToken) {\n        res.status(401).json({\n          error: \"Invalid access token.\",\n          errorURL: `http://${process.env.TOKENPASS_HOST || \"localhost\"}:${\n            process.env.TOKENPASS_PORT || \"21000\"\n          }/auth`,\n          code: 3,\n          success: false,\n        });\n        return;\n      }\n\n      let host = accessToken ? state.host : hostFromOrigin(req.headers);\n      // use host associated with the access token if provided\n      if (!host) {\n        // no host means its youself on localhost\n        host = process.env.TOKENPASS_HOST || \"localhost\";\n        console.log(\"no origin, using\", host);\n      }\n\n      const expired = state.expireTime && state.expireTime < Date.now();\n\n      console.log(\"SIGN:\", {\n        expireTime: state.expireTime,\n        now: Date.now(),\n        host,\n      });\n\n      // Check that the access token is not expired\n      if (expired) {\n        res.status(401).json({\n          error: \"Access token has expired.\",\n          errorURL: `http://${process.env.TOKENPASS_HOST || \"localhost\"}:${\n            process.env.TOKENPASS_PORT || \"21000\"\n          }/auth`,\n          code: 5,\n        });\n        return;\n      }\n\n      let key = await K.findOrCreate({ host: host });\n      if (key) {\n        let signedResponse = await K.sign({\n          message: message,\n          key: key,\n          encoding: encoding,\n          ts: Date.now(),\n        });\n\n        // Rotate the access token\n        // const newAccessToken = randomUUID();\n        // await S.update({\n        //   host,\n        //   accessToken: newAccessToken,\n        // });\n\n        // signedResponse.accessToken = newAccessToken;\n\n        res.status(200).json(signedResponse);\n        return;\n      } else {\n        res\n          .status(417)\n          .json({ error: \"please create a wallet.\", success: false });\n        return;\n      }\n    } else {\n      res.status(401).json({\n        errorURL: `http://${process.env.TOKENPASS_HOST || \"localhost\"}:${\n          process.env.TOKENPASS_PORT || \"21000\"\n        }/auth`,\n        error: \"Check that TokenPass is running and you're signed in.\",\n        code: 1,\n      });\n    }\n  });\n\n  app.post(\"/encrypt\", cors(), async (req, res) => {\n    let message = req.body.message;\n\n    if (K.getSeed()) {\n      // Check for an access token\n      const accessToken = req.headers.authorization;\n      if ((accessToken === undefined) | (accessToken === null)) {\n        res.status(401).json({\n          error: \"Please provide an access token in the Authorization header.\",\n          code: 2,\n          success: false,\n          errorURL: `http://${process.env.TOKENPASS_HOST || \"localhost\"}:${\n            process.env.TOKENPASS_PORT || \"21000\"\n          }/auth`,\n        });\n        return;\n      }\n\n      const host = hostFromOrigin(req.headers);\n\n      // TODO:Check that the access token is valid\n      const state = await S.findOne({ accessToken });\n      if (!state) {\n        res.status(401).json({\n          error: \"Invalid access token.\",\n          errorURL: `http://${process.env.TOKENPASS_HOST || \"localhost\"}:${\n            process.env.TOKENPASS_PORT || \"21000\"\n          }/auth`,\n          code: 3,\n          success: false,\n        });\n        return;\n      }\n\n      const key = await K.findOrCreate({ host: state.host });\n      if (!key) {\n        res.status(417).json({ error: \"please create a wallet.\" });\n        return;\n      }\n\n      const { address, data, sig, ts } = K.encrypt({ message, key });\n      console.log({ address, data, sig, ts });\n      res.status(200).json({ data, address, sig, ts });\n    } else {\n      res.status(401).json({\n        errorURL: `http://${process.env.TOKENPASS_HOST || \"localhost\"}:${\n          process.env.TOKENPASS_PORT || \"21000\"\n        }/auth`,\n        error: \"Check that TokenPass is running and you're signed in.\",\n        code: 1,\n      });\n    }\n  });\n\n  // First time seed creation\n  app.post(\"/register\", async (req, res) => {\n    let s = await seed.create(req.body.password);\n    K.setSeed(s);\n\n    // create first state for localhost with an icon\n    const state = await S.findOrCreate({\n      host: process.env.TOKENPASS_HOST || \"localhost\",\n    });\n    if (!state.icon) {\n      state.icon = \"/auth/icon\";\n      await S.update(state);\n    }\n\n    res.json({});\n  });\n\n  // Import seed\n  app.post(\"/import\", async (req, res) => {\n    try {\n      let s = await seed.importKey(req.body.hex, req.body.password);\n      K.setSeed(s);\n      res.json({});\n    } catch (e) {\n      res.json({ error: \"invalid seed\", success: false });\n    }\n  });\n\n  // Export seed\n  app.post(\"/export\", async (req, res) => {\n    try {\n      let hex = await seed.exportKey(req.body.password);\n      if (hex) {\n        res.json({ seed: hex });\n      } else {\n        res.status(401).json({\n          error: \"invalid\",\n          success: false,\n          errorURL: `http://${process.env.TOKENPASS_HOST || \"localhost\"}:${\n            process.env.TOKENPASS_PORT || \"21000\"\n          }/auth`,\n        });\n      }\n    } catch (e) {}\n  });\n\n  // Update state object\n  app.post(\"/state\", cors(), async (req, res) => {\n    let referer = req.headers.origin;\n    let host = new URL(referer).host;\n\n    const s = await S.findOne({ host });\n    if (s) {\n      if (req.query.mode === \"clear\") {\n        await S.delete({ host });\n        await S.update({ ...req.body, host });\n      } else {\n        S.update({ ...req.body, host });\n      }\n    } else {\n      S.insert({ ...req.body, host });\n    }\n\n    res.json({ success: true });\n  });\n\n  // Update profile object\n  app.post(\"/profile\", cors(), async (req, res) => {\n    if (K.getSeed()) {\n      let host = \"global\";\n      try {\n        const s = await S.findOne({ host });\n        let finalState = { ...req.body, host };\n        if (s) {\n          if (req.query.mode === \"clear\") {\n            await S.delete({ host });\n          }\n          S.update(finalState);\n        } else {\n          S.insert(finalState);\n        }\n        res.json({ success: true });\n      } catch (error) {\n        console.error(error);\n        res.status(500).json({ success: false, error: error.toString() });\n      }\n    } else {\n      res.status(401).json({\n        error:\n          \"please check that TokenPass is running and you're signed in. check TokenPass dashboard at http://localhost:21000\",\n        code: 1,\n        errorURL: `http://${process.env.TOKENPASS_HOST || \"localhost\"}:${\n          process.env.TOKENPASS_PORT || \"21000\"\n        }`,\n      });\n    }\n  });\n\n  // Update state object\n  app.delete(\"/state\", cors(), async (req, res) => {\n    let referer = req.headers.origin;\n    let host = new URL(referer).host;\n\n    S.delete({ ...req.body, host });\n\n    res.json({ success: true });\n  });\n\n  // Get the global profile\n  app.get(\"/profile\", cors(), async (req, res) => {\n    let state = await S.findOne({ host: \"global\" });\n    res.json(state);\n  });\n\n  // Get the state object\n  app.get(\"/state\", cors(), async (req, res) => {\n    let referer = req.headers.origin;\n    let host = new URL(referer).host;\n\n    let state = await S.findOne({ host });\n\n    res.json(state);\n  });\n\n  // Decrypt wallet with password at startup\n  app.post(\"/login\", async (req, res) => {\n    try {\n      let s = await seed.get(req.body.password);\n      if (s) {\n        K.setSeed(s);\n\n        // We do not give an access token here.\n        // Those are per hose, this is global\n        res.json({ success: true });\n      } else {\n        res.json({ error: \"invalid\", success: false });\n      }\n    } catch (e) {}\n  });\n\n  // Clear seed so the server stops signing requests\n  app.post(\"/logout\", cors(), (req, res) => {\n    K.setSeed(null);\n    res.json({ success: true });\n  });\n\n  // Ask a connected wallet to fund a raw tx\n  app.post(\"/fund\", cors(), async (req, res) => {\n    const key = K.getSeed();\n    if (key) {\n      const url = `http://${process.env.TOKENPASS_HOST || \"localhost\"}:${\n        process.env.TOKENPASS_PORT || \"21000\"\n      }/fund`;\n      let referer = req.headers.origin;\n      let host = referer ? new URL(referer).host : \"localhost\";\n\n      // make sure we have permission to fund for this host\n      const state = await S.findOne({ host });\n      if (!state.scopes?.includes(\"fund\")) {\n        res.status(403).json({\n          error: \"Insufficient permission\",\n          code: 7,\n        });\n        return;\n      }\n\n      const authToken = state.accessToken;\n      let rawtx = req.body.rawtx;\n      try {\n        const response = await fetch(url, {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n          },\n          body: JSON.stringify({\n            rawtx,\n            broadcast: true,\n            sigma: true,\n            host,\n            authToken,\n          }),\n        });\n\n        const json = await response.json();\n        res.json(json);\n      } catch (e) {\n        console.error(e);\n        res.status(500).json({ success: false, error: e.toString() });\n      }\n    } else {\n      res.status(401).json({\n        error:\n          \"please check that TokenPass is running and you're signed in. check TokenPass dashboard at http://localhost:21000\",\n        code: 1,\n        errorURL: `http://${process.env.TOKENPASS_HOST || \"localhost\"}:${\n          process.env.TOKENPASS_PORT || \"21000\"\n        }/auth`,\n      });\n    }\n  });\n\n  // Decrypt wallet with password at startup\n  app.post(\"/login\", async (req, res) => {\n    try {\n      let s = await seed.get(req.body.password);\n      if (s) {\n        K.setSeed(s);\n        res.json({ success: true });\n      } else {\n        res.json({ error: \"invalid\", success: false });\n      }\n    } catch (e) {}\n  });\n\n  // alias to vivi.railway.internal\n  // Create an auth token for some amount of time\n  app.post(\"/auth\", cors(), async (req, res) => {\n    console.log(\"AUTH ATTEMPTED FROM\", req.headers.origin, { host: req.body.host });\n    const pw = req.body.password;\n    try {\n      let s = await seed.get(pw);\n      if (s) {\n        K.setSeed(s);\n\n        // ! Forbid auth from any not allowed origin\n        // undefined is same network\n        if (\n          req.headers.origin &&\n          !allowedOrigins.includes(req.headers.origin)\n        ) {\n          res.status(403).json({\n            error: \"The origin is not authorized\",\n            code: 6,\n          });\n          return;\n        }\n\n        // Auth gets the host from the request body\n        const host = req.body.host;\n        console.log({ hosts: host, origin: req.headers.origin });\n\n        const expireSelection = req.body.expire;\n        const expireTime = expireSelectionToTime(expireSelection);\n\n        const accessToken = randomUUID();\n        const scopes = req.body.scopes?.split(\",\") || [];\n        const newState = {\n          host,\n          accessToken,\n          scopes,\n          icon: req.body.icon,\n          expireTime: Date.now() + expireTime,\n        };\n        await S.update(newState);\n        res.json({ success: true, accessToken, expireTime, host });\n      } else {\n        res.json({ error: \"invalid\", success: false });\n      }\n    } catch (e) {\n      res.status(500).json({ success: false, error: e.toString() });\n    }\n  });\n\n  // Ask wallet to prove ownership of a txid\n  app.get(\"/prove\", async (req, res) => {\n    let referer = req.headers.origin;\n    let host = new URL(referer).host;\n    let txid = req.query.txid;\n    let challengeStr = req.query.message;\n\n    // TODO: Find this txid in utxo store\n    let key = await Wallet.keyForTx(txid);\n    if (!key) {\n      res.status(404).json({\n        error: \"txid not found\",\n        code: 4,\n      });\n      return;\n    }\n    const { address, message, sig, ts } = Wallet.sign(challengeStr, key);\n    return res.json({ message, key, address, sig, ts });\n  });\n\n  // OAuth style login page for apps\n  app.get(\"/auth\", async (req, res) => {\n    const returnHost = new URL(req.query.returnURL).host;\n\n    // if host is undefined its localhost\n    const originHost = hostFromOrigin(req.headers);\n    const host = originHost || process.env.TOKENPASS_HOST || \"localhost\";\n\n    if (originHost && host !== returnHost) {\n      res.status(403).json({\n        error: \"The origin is not authorized \" + host + \" \" + returnHost,\n        code: 6,\n      });\n      return;\n    }\n\n    const returnURL = req.query.returnURL;\n    const icon = req.query.icon;\n    const scopes = req.query.scopes?.split(\",\") || [];\n\n    console.log(\"AUTH GET:\", {\n      returnURL,\n      icon,\n    });\n    res.render(\"auth\", {\n      returnURL,\n      icon,\n      scopes,\n      host: host || \"lostlhost\",\n    });\n  });\n\n  // Icon intended to be rendered in the auth page only\n  app.get(\"/auth/icon\", cors(), async (req, res) => {\n    // ! Forbid auth from any outside host\n    if (\n      req.headers.host !==\n      `${process.env.TOKENPASS_HOST || \"localhost\"}:${\n        process.env.TOKENPASS_PORT || \"21000\"\n      }`\n    ) {\n      res.status(403).json({\n        error: \"The origin is not authorized\" + req.headers.origin,\n        code: 6,\n      });\n      return;\n    }\n\n    // workaround to import not working in esm\n    const minidenticon = async (str) => {\n      const module = await import(\"minidenticons\");\n      return module.minidenticon(str);\n    };     \n\n    res.set(\"Content-Type\", \"image/svg+xml\");\n    res.set(\"Cache-Control\", \"max-age=31536000\");\n\n    // derive a icon from localhost key\n    if (K.getSeed()) {\n      let k = await K.findOrCreate({\n        host: \"localhost\",\n      });\n      res.send(await minidenticon(k.pub));\n    } else {\n      // default icon\n      res.send(await minidenticon(\"Anon\"));\n    }\n  });\n\n  // Dashboard web page\n  app.get(\"/\", async (req, res) => {\n    if (K.getSeed()) {\n      // if host is specified\n      let keys = (await K.all()) || [];\n      let states = (await S.all()) || [];\n      res.render(\"home\", { keys, states, seed: true });\n    } else {\n      let seedCount = await seed.count();\n      if (seedCount) {\n        const host = hostFromOrigin(req.headers);\n        res.render(\"login\", { host });\n      } else {\n        res.render(\"home\", { seed: false });\n      }\n    }\n  });\n\n  app.listen(process.env.TOKENPASS_PORT || defaultPort, () => {\n    console.log(\n      `TokenPass listening at http://${\n        process.env.TOKENPASS_HOST || \"localhost\"\n      }:${process.env.TOKENPASS_PORT || \"21000\"}`\n    );\n  });\n};\nexport { init };\n"],"names":["Key","config","this","db","Datastore","filename","autoload","wallet","_proto","prototype","setSeed","s","seed","getSeed","sign","o","message","key","encoding","encrypt","findOrCreate","_this","Promise","resolve","findOne","then","_exit","_temp2","count","create","_this$wallet$create","insert","_this$insert","console","log","_temp","_result","e","reject","_this2","err","transform","find","_this3","keys","map","k","_this4","_this5","doc","derived","derive","path","priv","privateKey","toString","pub","publicKey","address","toAddress","all","_this6","text","keystr","keyBuffer","iv","crypto","randomBytes","createHash","update","digest","cipher","createCipheriv","encrypted","Buffer","concat","encryptedData","Seed","get","password","r","decrypted","from","encryptedText","decipher","createDecipheriv","decrypt","hex","importKey","res","exportKey","State","setState","state","getState","host","_id","states","remove","_this7","$set","upsert","returnUpdatedDocs","numReplaced","accessToken","_this8","_","bitcore","deps","PrivateKey","PublicKey","Address","BufferWriter","ECDSA","Signature","sha256sha256","Hash","JSUtil","util","js","$","preconditions","Message","checkArgument","isString","includes","MAGIC_BYTES","magicHash","prefix1","varintBufNum","length","messageBuffer","prefix2","buf","_sign","hash","ecdsa","hashbuf","privkey","pubkey","toPublicKey","signRandomK","calci","sig","wif","toWIF","fromWIF","toCompact","_verify","signature","verified","verify","error","bitcoinAddress","signatureString","fromString","fromCompact","signatureAddress","fromPublicKey","network","str","fromJSON","json","isValidJSON","JSON","parse","toObject","toJSON","stringify","inspect","global","_bitcore","msg","ts","Date","now","data","enc","toBuffer","account","deriveChild","Random","getRandomBuffer","HDPrivateKey","fromSeed","_catch","body","recover","result","__filename","fileURLToPath","document","location","require","href","currentScript","src","URL","baseURI","__dirname","dirname","app","express","allowedOrigins","process","env","TOKENPASS_HOST","TOKENPASS_PORT","whitelist","TOKENPASS_ORIGIN_WHITELIST","push","apply","split","hostFromOrigin","headers","origin","dbpath","fs","existsSync","mkdirSync","recursive","Wallet","K","S","set","join","use","timeout","bodyParser","limit","raw","type","urlencoded","extended","options","cors","post","req","authToken","authorization","undefined","status","code","success","errorURL","expired","expireTime","signedResponse","_K$encrypt","icon","_temp3","_temp4","_temp7","_temp6","_temp5","query","mode","_extends","_temp13","_temp12","_temp11","finalState","_temp10","_temp9","_temp8","_temp14","url","referer","_state$scopes","scopes","rawtx","_temp15","fetch","method","broadcast","sigma","response","_temp16","pw","_req$body$scopes","hosts","expireSelection","expireSelectionToTime","expire","randomUUID","newState","challengeStr","txid","_Wallet$sign","_req$query$scopes","returnHost","returnURL","originHost","render","minidenticon","import","module","_temp17","_send","send","_minidenticon","call","_send2","_minidenticon2","_temp18","seedCount","listen"],"mappings":"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"}